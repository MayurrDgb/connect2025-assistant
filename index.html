// ID de votre Google Sheet
const SHEET_ID = '1-m3hZfKjsZU7NuEEf0dvrDIkY23mcAp2D7R5erOu0Nk';
const DRIVE_FOLDER_ID = '1oPFFxN6GIg9E3sHhAaDad_lcGOWBzNvw';
const DATA_SHEET_NAME = 'Data';

// Cache simple pour √©viter les lectures r√©p√©t√©es
let sheetCache = null;
let cacheTime = 0;
const CACHE_DURATION = 30000; // 30 secondes

function doPost(e) {
  try {
    console.log('Requ√™te re√ßue:', e.postData.contents);
    
    const data = JSON.parse(e.postData.contents);
    const action = data.action;
    
    console.log('Action demand√©e:', action);
    
    switch(action) {
      case 'authenticate':
        return authenticatePartner(data.codeUnique);
      case 'get-partner-data':
        return getPartnerData(data.codeUnique);
      case 'save-description':
        return saveDescription(data.codeUnique, data.description);
      case 'save-equipment':
        return saveEquipment(data.codeUnique, data.equipment);
      case 'save-delivery-date':
        return saveDeliveryDate(data.codeUnique, data.deliveryDate);
      case 'save-logo-type':
        return saveLogoType(data.codeUnique, data.logoType, data.status);
      case 'clear-equipment':
        return clearEquipment(data.codeUnique);
      case 'upload-file':
        return handleFileUpload(data);
      // Actions fichiers
      case 'get-partner-files':
        return getPartnerFiles(data.codeUnique);
      case 'download-file':
        return downloadFile(data.fileId);
      case 'delete-file':
        return deleteFile(data.fileId, data.codeUnique, data.logoType);
      // Actions admin
      case 'get-all-partners':
        return getAllPartners();
      case 'add-partner':
        return addPartner(data.companyName, data.contactName, data.contactEmail, data.contactPhone);
      // Envoi d'email
      case 'send-email':
        return sendEmail(data.to, data.subject, data.htmlContent);
      case 'export-data':
        return exportData();
      // Actions suppression et sync
      case 'delete-partner':
        return deletePartner(data.partnerCode);
      case 'force-sync':
        return forceSyncPartners();
      // Sauvegarde dans champ sp√©cifique
      case 'save-field':
        return saveField(data.codeUnique, data.fieldName, data.value);
      default:
        return createResponse(false, 'Action non reconnue: ' + action);
    }
  } catch (error) {
    console.error('Erreur dans doPost:', error);
    return createResponse(false, 'Erreur: ' + error.message);
  }
}

// Fonction pour obtenir les donn√©es avec cache
function getSheetDataCached() {
  const now = Date.now();
  
  // Utiliser le cache si r√©cent
  if (sheetCache && (now - cacheTime) < CACHE_DURATION) {
    return sheetCache;
  }
  
  // Sinon, recharger
  const spreadsheet = SpreadsheetApp.openById(SHEET_ID);
  const sheet = spreadsheet.getSheetByName(DATA_SHEET_NAME);
  const data = sheet.getDataRange().getValues();
  
  sheetCache = { sheet, data, headers: data[0] };
  cacheTime = now;
  
  return sheetCache;
}

// Invalider le cache lors des modifications
function invalidateCache() {
  sheetCache = null;
  cacheTime = 0;
}

function authenticatePartner(codeUnique) {
  try {
    console.log('Authentification pour:', codeUnique);
    
    const { data } = getSheetDataCached();
    
    console.log('Nombre de lignes dans onglet Data:', data.length);
    console.log('Headers:', data[0]);
    
    for (let i = 1; i < data.length; i++) {
      const rowCode = data[i][0];
      console.log('Ligne ' + i + ': Code trouv√© = "' + rowCode + '", Recherch√© = "' + codeUnique + '"');
      
      if (rowCode && rowCode.toString().trim() === codeUnique.toString().trim()) {
        console.log('Code trouv√© √† la ligne', i + 1);
        return createResponse(true, 'Authentification r√©ussie', { codeUnique });
      }
    }
    
    console.log('Code non trouv√© dans onglet Data');
    return createResponse(false, 'Code d\'acc√®s incorrect');
    
  } catch (error) {
    console.error('Erreur authentification:', error);
    return createResponse(false, 'Erreur technique: ' + error.message);
  }
}

// Utiliser le cache
function getPartnerData(codeUnique) {
  try {
    console.log('R√©cup√©ration donn√©es pour:', codeUnique);
    
    const { data, headers } = getSheetDataCached();
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] && data[i][0].toString().trim() === codeUnique.toString().trim()) {
        const partnerData = {};
        
        headers.forEach((header, index) => {
          let value = data[i][index] || '';
          
          // Nettoyer les #REF! √† la vol√©e
          if (value === '#REF!') {
            if (header === 'Deadline') value = '2025-09-01T22:00:00.000Z';
            else if (header === 'Jours restants') value = calculateDaysRemaining('2025-09-01');
            else if (header === 'Priorit√©') value = 'üü¢ OK';
            else value = '';
          }
          
          partnerData[header] = value;
        });
        
        return createResponse(true, 'Donn√©es r√©cup√©r√©es', partnerData);
      }
    }
    
    return createResponse(false, 'Partenaire non trouv√©');
    
  } catch (error) {
    console.error('Erreur r√©cup√©ration donn√©es:', error);
    return createResponse(false, 'Erreur technique: ' + error.message);
  }
}

// R√©cup√©rer tous les partenaires avec rafra√Æchissement forc√©
function getAllPartners() {
  try {
    console.log('R√©cup√©ration de tous les partenaires (admin)');
    
    // Forcer le rafra√Æchissement du cache
    invalidateCache();
    const { data, headers } = getSheetDataCached();
    
    const allPartners = [];
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][0]) { // Si il y a un code unique
        const partnerData = {};
        
        headers.forEach((header, index) => {
          let value = data[i][index] || '';
          
          // Nettoyer les #REF! √† la vol√©e
          if (value === '#REF!') {
            if (header === 'Deadline') value = '2025-09-01T22:00:00.000Z';
            else if (header === 'Jours restants') value = calculateDaysRemaining('2025-09-01');
            else if (header === 'Priorit√©') value = 'üü¢ OK';
            else value = '';
          }
          
          partnerData[header] = value;
        });
        
        allPartners.push(partnerData);
      }
    }
    
    console.log('Tous les partenaires r√©cup√©r√©s:', allPartners.length);
    return createResponse(true, 'Tous les partenaires r√©cup√©r√©s', allPartners);
    
  } catch (error) {
    console.error('Erreur r√©cup√©ration tous partenaires:', error);
    return createResponse(false, 'Erreur technique: ' + error.message);
  }
}

// Ajouter un partenaire avec les nouveaux champs
function addPartner(companyName, contactName, contactEmail, contactPhone) {
  try {
    console.log('Ajout partenaire:', { companyName, contactName, contactEmail });
    
    const spreadsheet = SpreadsheetApp.openById(SHEET_ID);
    const sheet = spreadsheet.getSheetByName(DATA_SHEET_NAME);
    
    if (!sheet) {
      console.error('Onglet Data non trouv√©');
      return createResponse(false, 'Erreur: Onglet Data non trouv√©');
    }
    
    // G√©n√©rer un code partenaire unique
    const partnerCode = generatePartnerCode();
    
    // V√©rifier que le code n'existe pas d√©j√†
    const data = sheet.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === partnerCode) {
        // Code existe d√©j√†, en g√©n√©rer un nouveau
        return addPartner(companyName, contactName, contactEmail, contactPhone);
      }
    }
    
    // Cr√©er la ligne avec TOUTES les colonnes dans l'ordre exact
    const headers = data[0];
    console.log('Headers trouv√©s:', headers);
    
    // Valeurs par d√©faut avec nouveaux champs
    const defaultValues = {
      'Code Unique': partnerCode,
      'Nom Entreprise': companyName,
      'Nom Contact': contactName,
      'Email Contact': contactEmail,
      'T√©l√©phone': contactPhone || '',
      'Logo CMJN': '',
      'Logo N√©gatif': '',
      'Descriptif entreprise': '',
      '√âquipements apport√©s': '',
      'Dimensions √©quipements': '',
      'Mat√©riel encombrant': '',
      'Date livraison souhait√©e': '',
      'Instructions livraison sp√©ciales': '',
      'Besoins connectivit√© additionnels': '',
      'Atelier': '',
      'Speedmeeting': '',
      'R√©gimes alimentaires et allergies': '',
      'Tailles t-shirts': '', // NOUVEAU
      'Statut Global': 'üî¥ Incomplet',
      'Progression %': 0,
      'Deadline': '2025-09-01T22:00:00.000Z',
      'Jours restants': calculateDaysRemaining('2025-09-01'),
      'Priorit√©': 'üü¢ OK',
      'Derni√®re modification': new Date(),
      'Notes internes': 'Ajout√© via admin'
    };
    
    // Cr√©er la ligne dans l'ordre exact des headers
    const newRow = [];
    headers.forEach(header => {
      if (defaultValues.hasOwnProperty(header)) {
        newRow.push(defaultValues[header]);
      } else {
        newRow.push(''); // Valeur vide pour les colonnes non reconnues
      }
    });
    
    console.log('Nouvelle ligne √† ajouter:', newRow);
    console.log('Nombre de colonnes headers:', headers.length);
    console.log('Nombre de valeurs dans newRow:', newRow.length);
    
    // Ajouter la ligne au sheet
    sheet.appendRow(newRow);
    
    // Cr√©er le dossier Drive pour l'entreprise
    createCompanyFolder(companyName);
    
    // Forcer la sauvegarde et invalider le cache
    SpreadsheetApp.flush();
    invalidateCache();
    
    console.log('Partenaire ajout√© avec le code:', partnerCode);
    
    return createResponse(true, 'Partenaire ajout√© avec succ√®s', {
      partnerCode: partnerCode,
      companyName: companyName,
      contactName: contactName,
      contactEmail: contactEmail
    });
    
  } catch (error) {
    console.error('Erreur ajout partenaire:', error);
    return createResponse(false, 'Erreur technique: ' + error.message);
  }
}

// Cr√©er un dossier pour l'entreprise dans Drive
function createCompanyFolder(companyName) {
  try {
    console.log('Cr√©ation dossier pour:', companyName);
    
    const parentFolder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
    
    // Nettoyer le nom de l'entreprise
    const cleanCompanyName = companyName.replace(/[<>:"/\\|?*]/g, '_').trim();
    
    // V√©rifier si le dossier existe d√©j√†
    const existingFolders = parentFolder.getFoldersByName(cleanCompanyName);
    
    if (existingFolders.hasNext()) {
      console.log('Dossier existe d√©j√† pour:', cleanCompanyName);
      return existingFolders.next();
    }
    
    // Cr√©er le dossier
    const newFolder = parentFolder.createFolder(cleanCompanyName);
    console.log('Dossier cr√©√©:', newFolder.getId());
    
    return newFolder;
    
  } catch (error) {
    console.error('Erreur cr√©ation dossier:', error);
    return null;
  }
}

// Obtenir ou cr√©er le dossier d'une entreprise
function getOrCreateCompanyFolder(companyName) {
  try {
    console.log('Recherche/cr√©ation dossier pour:', companyName);
    
    const parentFolder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
    console.log('Dossier parent:', parentFolder.getName());
    
    // Nettoyer le nom de l'entreprise (supprimer caract√®res sp√©ciaux)
    const cleanCompanyName = companyName.replace(/[<>:"/\\|?*]/g, '_').trim();
    console.log('Nom nettoy√©:', cleanCompanyName);
    
    // Chercher le dossier existant
    const existingFolders = parentFolder.getFoldersByName(cleanCompanyName);
    
    if (existingFolders.hasNext()) {
      const existingFolder = existingFolders.next();
      console.log('Dossier existant trouv√©:', existingFolder.getName(), 'ID:', existingFolder.getId());
      return existingFolder;
    }
    
    // Cr√©er le dossier s'il n'existe pas
    console.log('Cr√©ation nouveau dossier:', cleanCompanyName);
    const newFolder = parentFolder.createFolder(cleanCompanyName);
    console.log('Dossier cr√©√©:', newFolder.getName(), 'ID:', newFolder.getId());
    
    return newFolder;
    
  } catch (error) {
    console.error('Erreur obtention/cr√©ation dossier:', error);
    return null;
  }
}

// Supprimer un partenaire
function deletePartner(partnerCode) {
  try {
    console.log('Suppression partenaire:', partnerCode);
    
    const spreadsheet = SpreadsheetApp.openById(SHEET_ID);
    const sheet = spreadsheet.getSheetByName(DATA_SHEET_NAME);
    
    if (!sheet) {
      console.error('Onglet Data non trouv√©');
      return createResponse(false, 'Erreur: Onglet Data non trouv√©');
    }
    
    const data = sheet.getDataRange().getValues();
    
    // Chercher la ligne √† supprimer
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] && data[i][0].toString().trim() === partnerCode.toString().trim()) {
        // Supprimer la ligne
        sheet.deleteRow(i + 1);
        
        // Forcer la sauvegarde et invalider le cache
        SpreadsheetApp.flush();
        invalidateCache();
        
        console.log('Partenaire supprim√©:', partnerCode);
        return createResponse(true, 'Partenaire supprim√© avec succ√®s');
      }
    }
    
    console.log('Partenaire non trouv√© pour suppression:', partnerCode);
    return createResponse(false, 'Partenaire non trouv√©');
    
  } catch (error) {
    console.error('Erreur suppression partenaire:', error);
    return createResponse(false, 'Erreur technique: ' + error.message);
  }
}

// Forcer la synchronisation
function forceSyncPartners() {
  try {
    console.log('Synchronisation forc√©e...');
    
    // Invalider le cache pour forcer le rechargement
    invalidateCache();
    
    const spreadsheet = SpreadsheetApp.openById(SHEET_ID);
    const sheet = spreadsheet.getSheetByName(DATA_SHEET_NAME);
    
    if (!sheet) {
      return createResponse(false, 'Onglet Data non trouv√©');
    }
    
    // Forcer le rafra√Æchissement complet
    SpreadsheetApp.flush();
    
    // Attendre un peu
    Utilities.sleep(1000);
    
    // R√©cup√©rer les donn√©es fra√Æches
    const data = sheet.getDataRange().getValues();
    
    console.log('Synchronisation termin√©e');
    console.log('Nombre de partenaires apr√®s sync:', data.length - 1);
    
    return createResponse(true, 'Synchronisation termin√©e', {
      totalPartners: data.length - 1
    });
    
  } catch (error) {
    console.error('Erreur sync:', error);
    return createResponse(false, 'Erreur: ' + error.message);
  }
}

// Sauvegarder dans un champ sp√©cifique
function saveField(codeUnique, fieldName, value) {
  try {
    console.log('Sauvegarde champ sp√©cifique:', { codeUnique, fieldName, value });
    
    const spreadsheet = SpreadsheetApp.openById(SHEET_ID);
    const sheet = spreadsheet.getSheetByName(DATA_SHEET_NAME);
    
    if (!sheet) {
      console.error('Onglet Data non trouv√©');
      return createResponse(false, 'Erreur: Onglet Data non trouv√©');
    }
    
    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    
    // Trouver la colonne correspondante
    const columnIndex = headers.indexOf(fieldName);
    if (columnIndex === -1) {
      console.log('Colonne non trouv√©e:', fieldName);
      console.log('Colonnes disponibles:', headers);
      return createResponse(false, 'Colonne non trouv√©e: ' + fieldName);
    }
    
    // Chercher le partenaire et mettre √† jour
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] && data[i][0].toString().trim() === codeUnique.toString().trim()) {
        // Mettre √† jour le champ
        sheet.getRange(i + 1, columnIndex + 1).setValue(value);
        
        // Mettre √† jour la date de modification
        const lastModColumnIndex = headers.indexOf('Derni√®re modification');
        if (lastModColumnIndex !== -1) {
          sheet.getRange(i + 1, lastModColumnIndex + 1).setValue(new Date());
        }
        
        // Mettre √† jour la progression
        updateProgression(sheet, headers, i + 1);
        
        // Invalider le cache
        invalidateCache();
        
        console.log('Champ sauvegard√©:', fieldName, '=', value);
        return createResponse(true, 'Champ sauvegard√© avec succ√®s');
      }
    }
    
    console.log('Partenaire non trouv√© pour sauvegarde champ');
    return createResponse(false, 'Partenaire non trouv√©');
    
  } catch (error) {
    console.error('Erreur sauvegarde champ:', error);
    return createResponse(false, 'Erreur technique: ' + error.message);
  }
}

// Fonction d'envoi d'email
function sendEmail(to, subject, htmlContent) {
  try {
    console.log('Envoi email √†:', to, 'Objet:', subject);
    
    // Validation
    if (!to || !subject || !htmlContent) {
      return createResponse(false, 'Param√®tres email manquants (to, subject, htmlContent requis)');
    }
    
    // Validation format email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(to)) {
      return createResponse(false, 'Format email invalide');
    }
    
    GmailApp.sendEmail(
      to,
      subject,
      '',
      {
        htmlBody: htmlContent,
        from: 'events@mbefrance.fr',
        name: 'MBE France - Connect 2025'
      }
    );
    
    console.log('Email envoy√© avec succ√®s');
    return createResponse(true, 'Email envoy√© avec succ√®s');
    
  } catch (error) {
    console.error('Erreur envoi email:', error);
    
    // Gestion des erreurs sp√©cifiques Gmail
    let errorMessage = error.toString();
    
    if (errorMessage.includes('quota')) {
      errorMessage = 'Quota d\'envoi d\'emails d√©pass√©';
    } else if (errorMessage.includes('permission')) {
      errorMessage = 'Permissions Gmail insuffisantes';
    } else if (errorMessage.includes('invalid')) {
      errorMessage = 'Adresse email invalide';
    }
    
    return createResponse(false, 'Erreur envoi email: ' + errorMessage);
  }
}

function generatePartnerCode() {
  const randomNumber = Math.floor(Math.random() * 99999).toString().padStart(5, '0');
  return 'C25MBE' + randomNumber;
}

function calculateDaysRemaining(deadlineString) {
  try {
    const deadline = new Date(deadlineString);
    const now = new Date();
    const diffTime = deadline - now;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return Math.max(0, diffDays);
  } catch (error) {
    return 0;
  }
}

function exportData() {
  try {
    console.log('Export des donn√©es');
    
    const { data, headers } = getSheetDataCached();
    
    const exportData = [];
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][0]) {
        const rowData = {};
        
        headers.forEach((header, index) => {
          rowData[header] = data[i][index] || '';
        });
        
        exportData.push(rowData);
      }
    }
    
    console.log('Donn√©es export√©es:', exportData.length, 'partenaires');
    return createResponse(true, 'Donn√©es export√©es avec succ√®s', exportData);
    
  } catch (error) {
    console.error('Erreur export:', error);
    return createResponse(false, 'Erreur technique: ' + error.message);
  }
}

// Sauvegarder le descriptif avec invalidation du cache
function saveDescription(codeUnique, description) {
  try {
    console.log('Sauvegarde descriptif pour:', codeUnique);
    
    const spreadsheet = SpreadsheetApp.openById(SHEET_ID);
    const sheet = spreadsheet.getSheetByName(DATA_SHEET_NAME);
    
    if (!sheet) {
      console.error('Onglet Data non trouv√©');
      return createResponse(false, 'Erreur: Onglet Data non trouv√©');
    }
    
    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    
    const descriptionColumnIndex = headers.indexOf('Descriptif entreprise');
    if (descriptionColumnIndex === -1) {
      console.log('Colonne Descriptif entreprise non trouv√©e');
      console.log('Colonnes disponibles:', headers);
      return createResponse(false, 'Colonne descriptif non trouv√©e');
    }
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] && data[i][0].toString().trim() === codeUnique.toString().trim()) {
        sheet.getRange(i + 1, descriptionColumnIndex + 1).setValue(description);
        
        const lastModColumnIndex = headers.indexOf('Derni√®re modification');
        if (lastModColumnIndex !== -1) {
          sheet.getRange(i + 1, lastModColumnIndex + 1).setValue(new Date());
        }
        
        updateProgression(sheet, headers, i + 1);
        
        // Invalider le cache
        invalidateCache();
        
        console.log('Descriptif sauvegard√© dans onglet Data');
        return createResponse(true, 'Descriptif sauvegard√©');
      }
    }
    
    console.log('Partenaire non trouv√© pour sauvegarde');
    return createResponse(false, 'Partenaire non trouv√©');
    
  } catch (error) {
    console.error('Erreur sauvegarde:', error);
    return createResponse(false, 'Erreur technique: ' + error.message);
  }
}

function saveEquipment(codeUnique, equipment) {
  try {
    console.log('Sauvegarde √©quipement pour:', codeUnique, '√âquipement:', equipment);
    
    const spreadsheet = SpreadsheetApp.openById(SHEET_ID);
    const sheet = spreadsheet.getSheetByName(DATA_SHEET_NAME);
    
    if (!sheet) {
      console.error('Onglet Data non trouv√©');
      return createResponse(false, 'Erreur: Onglet Data non trouv√©');
    }
    
    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    
    const equipmentColumnIndex = headers.indexOf('√âquipements apport√©s');
    if (equipmentColumnIndex === -1) {
      console.log('Colonne √âquipements apport√©s non trouv√©e');
      return createResponse(false, 'Colonne √©quipements non trouv√©e');
    }
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] && data[i][0].toString().trim() === codeUnique.toString().trim()) {
        const existingEquipment = data[i][equipmentColumnIndex] || '';
        
        let newEquipment = equipment;
        let action = 'ajout';
        
        if (existingEquipment && existingEquipment.trim() !== '') {
          const isModification = detectModification(existingEquipment, equipment);
          
          if (isModification) {
            newEquipment = equipment;
            action = 'modification';
            console.log('Modification d√©tect√©e - remplacement');
          } else {
            newEquipment = existingEquipment + ' + ' + equipment;
            action = 'ajout';
            console.log('Ajout d√©tect√© - ajout avec +');
          }
        }
        
        sheet.getRange(i + 1, equipmentColumnIndex + 1).setValue(newEquipment);
        
        const lastModColumnIndex = headers.indexOf('Derni√®re modification');
        if (lastModColumnIndex !== -1) {
          sheet.getRange(i + 1, lastModColumnIndex + 1).setValue(new Date());
        }
        
        updateProgression(sheet, headers, i + 1);
        
        // Invalider le cache
        invalidateCache();
        
        console.log('√âquipement ' + action + ':', newEquipment);
        return createResponse(true, '√âquipement ' + action + ' avec succ√®s', { 
          equipment: newEquipment,
          action: action
        });
      }
    }
    
    return createResponse(false, 'Partenaire non trouv√©');
    
  } catch (error) {
    console.error('Erreur sauvegarde √©quipement:', error);
    return createResponse(false, 'Erreur technique: ' + error.message);
  }
}

function detectModification(existingEquipment, newEquipment) {
  const existing = existingEquipment.toLowerCase();
  const newEq = newEquipment.toLowerCase();
  
  const modificationKeywords = [
    'modifier', 'changer', 'corriger', 'remplacer', 'plut√¥t', 'en fait',
    'finalement', 'correction', 'erreur', 'rectifier', 'plutot'
  ];
  
  if (modificationKeywords.some(keyword => newEq.includes(keyword))) {
    return true;
  }
  
  // Plus flexible pour tous types d'√©quipements
  const equipmentTypes = ['imprimante', '√©cran', 'stand', 'ordinateur', 'tablette', 'projecteur', 'borne', 'affiche', 'livre', 'bouteille', 'mat√©riel'];
  
  let existingType = '';
  let newType = '';
  
  for (const type of equipmentTypes) {
    if (existing.includes(type)) {
      existingType = type;
      break;
    }
  }
  
  for (const type of equipmentTypes) {
    if (newEq.includes(type)) {
      newType = type;
      break;
    }
  }
  
  if (existingType && newType && existingType === newType) {
    const existingDimensions = existing.match(/(\d+(?:\.\d+)?)\s*[mx√ó]\s*(\d+(?:\.\d+)?)/);
    const newDimensions = newEq.match(/(\d+(?:\.\d+)?)\s*[mx√ó]\s*(\d+(?:\.\d+)?)/);
    
    const existingQuantity = existing.match(/(\d+)\s*/);
    const newQuantity = newEq.match(/(\d+)\s*/);
    
    if ((existingDimensions && newDimensions) || (existingQuantity && newQuantity)) {
      return true;
    }
  }
  
  return false;
}

function clearEquipment(codeUnique) {
  try {
    console.log('Effacement √©quipement pour:', codeUnique);
    
    const spreadsheet = SpreadsheetApp.openById(SHEET_ID);
    const sheet = spreadsheet.getSheetByName(DATA_SHEET_NAME);
    
    if (!sheet) {
      return createResponse(false, 'Erreur: Onglet Data non trouv√©');
    }
    
    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    
    const equipmentColumnIndex = headers.indexOf('√âquipements apport√©s');
    if (equipmentColumnIndex === -1) {
      return createResponse(false, 'Colonne √©quipements non trouv√©e');
    }
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] && data[i][0].toString().trim() === codeUnique.toString().trim()) {
        sheet.getRange(i + 1, equipmentColumnIndex + 1).setValue('');
        
        const lastModColumnIndex = headers.indexOf('Derni√®re modification');
        if (lastModColumnIndex !== -1) {
          sheet.getRange(i + 1, lastModColumnIndex + 1).setValue(new Date());
        }
        
        updateProgression(sheet, headers, i + 1);
        
        // Invalider le cache
        invalidateCache();
        
        console.log('√âquipement effac√©');
        return createResponse(true, '√âquipement effac√© avec succ√®s');
      }
    }
    
    return createResponse(false, 'Partenaire non trouv√©');
    
  } catch (error) {
    console.error('Erreur effacement:', error);
    return createResponse(false, 'Erreur technique: ' + error.message);
  }
}

function saveDeliveryDate(codeUnique, deliveryDate) {
  try {
    console.log('Sauvegarde date livraison pour:', codeUnique, 'Date:', deliveryDate);
    
    const spreadsheet = SpreadsheetApp.openById(SHEET_ID);
    const sheet = spreadsheet.getSheetByName(DATA_SHEET_NAME);
    
    if (!sheet) {
      console.error('Onglet Data non trouv√©');
      return createResponse(false, 'Erreur: Onglet Data non trouv√©');
    }
    
    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    
    const dateColumnIndex = headers.indexOf('Date livraison souhait√©e');
    if (dateColumnIndex === -1) {
      console.log('Colonne Date livraison souhait√©e non trouv√©e');
      console.log('Colonnes disponibles:', headers);
      return createResponse(false, 'Colonne date livraison non trouv√©e');
    }
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] && data[i][0].toString().trim() === codeUnique.toString().trim()) {
        let formattedDate = deliveryDate;
        
        const dateMatch = deliveryDate.match(/(22|23|24|25|26)\s+septembre/i);
        if (dateMatch) {
          formattedDate = dateMatch[1] + ' septembre 2025';
        }
        
        sheet.getRange(i + 1, dateColumnIndex + 1).setValue(formattedDate);
        
        const lastModColumnIndex = headers.indexOf('Derni√®re modification');
        if (lastModColumnIndex !== -1) {
          sheet.getRange(i + 1, lastModColumnIndex + 1).setValue(new Date());
        }
        
        updateProgression(sheet, headers, i + 1);
        
        // Invalider le cache
        invalidateCache();
        
        console.log('Date livraison sauvegard√©e:', formattedDate);
        return createResponse(true, 'Date livraison sauvegard√©e', { deliveryDate: formattedDate });
      }
    }
    
    console.log('Partenaire non trouv√© pour sauvegarde date');
    return createResponse(false, 'Partenaire non trouv√©');
    
  } catch (error) {
    console.error('Erreur sauvegarde date:', error);
    return createResponse(false, 'Erreur technique: ' + error.message);
  }
}

function saveLogoType(codeUnique, logoType, status) {
  try {
    console.log('Sauvegarde type logo pour:', codeUnique, 'Type:', logoType, 'Statut:', status);
    
    const spreadsheet = SpreadsheetApp.openById(SHEET_ID);
    const sheet = spreadsheet.getSheetByName(DATA_SHEET_NAME);
    
    if (!sheet) {
      console.error('Onglet Data non trouv√©');
      return createResponse(false, 'Erreur: Onglet Data non trouv√©');
    }
    
    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    
    const logoColumnIndex = headers.indexOf(logoType);
    if (logoColumnIndex === -1) {
      console.log('Colonne logo non trouv√©e:', logoType);
      console.log('Colonnes disponibles:', headers);
      return createResponse(false, 'Colonne logo non trouv√©e');
    }
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] && data[i][0].toString().trim() === codeUnique.toString().trim()) {
        sheet.getRange(i + 1, logoColumnIndex + 1).setValue(status);
        
        const lastModColumnIndex = headers.indexOf('Derni√®re modification');
        if (lastModColumnIndex !== -1) {
          sheet.getRange(i + 1, lastModColumnIndex + 1).setValue(new Date());
        }
        
        updateProgression(sheet, headers, i + 1);
        
        // Invalider le cache
        invalidateCache();
        
        console.log('Type logo sauvegard√©:', logoType, status);
        return createResponse(true, 'Type logo sauvegard√©', { logoType, status });
      }
    }
    
    console.log('Partenaire non trouv√© pour sauvegarde logo');
    return createResponse(false, 'Partenaire non trouv√©');
    
  } catch (error) {
    console.error('Erreur sauvegarde logo:', error);
    return createResponse(false, 'Erreur technique: ' + error.message);
  }
}

// Progression avec nouveaux champs
function updateProgression(sheet, headers, rowIndex) {
  try {
    const progressionColumnIndex = headers.indexOf('Progression %');
    if (progressionColumnIndex === -1) return;
    
    // Champs √† v√©rifier pour la progression avec nouveaux champs
    const fieldsToCheck = [
      'Descriptif entreprise',
      '√âquipements apport√©s',
      'Date livraison souhait√©e',
      'Logo CMJN',
      'Logo N√©gatif',
      'Atelier',
      'Speedmeeting',
      'R√©gimes alimentaires et allergies',
      'Tailles t-shirts' // NOUVEAU
    ];
    
    let completedFields = 0;
    const totalFields = fieldsToCheck.length;
    
    fieldsToCheck.forEach(fieldName => {
      const columnIndex = headers.indexOf(fieldName);
      if (columnIndex !== -1) {
        const cellValue = sheet.getRange(rowIndex, columnIndex + 1).getValue();
        if (cellValue && cellValue.toString().trim() !== '') {
          completedFields++;
        }
      }
    });
    
    const progression = Math.round((completedFields / totalFields) * 100);
    
    sheet.getRange(rowIndex, progressionColumnIndex + 1).setValue(progression);
    
    const statusColumnIndex = headers.indexOf('Statut Global');
    if (statusColumnIndex !== -1) {
      let status = 'üî¥ Incomplet';
      if (progression >= 100) {
        status = 'üü¢ Complet';
      } else if (progression >= 50) {
        status = 'üü° Partiel';
      }
      sheet.getRange(rowIndex, statusColumnIndex + 1).setValue(status);
    }
    
    const joursRestantsColumnIndex = headers.indexOf('Jours restants');
    const deadlineColumnIndex = headers.indexOf('Deadline');
    if (joursRestantsColumnIndex !== -1 && deadlineColumnIndex !== -1) {
      const deadline = sheet.getRange(rowIndex, deadlineColumnIndex + 1).getValue();
      if (deadline) {
        const joursRestants = calculateDaysRemaining(deadline);
        sheet.getRange(rowIndex, joursRestantsColumnIndex + 1).setValue(joursRestants);
      }
    }
    
    console.log('Progression mise √† jour:', progression + '%');
    
  } catch (error) {
    console.error('Erreur mise √† jour progression:', error);
  }
}

// Upload fichier avec lien vers le dossier entreprise
function handleFileUpload(data) {
  try {
    console.log('Upload fichier complet:', data.fileName);
    
    const { fileName, fileSize, contentType, codeUnique, companyName, logoType, fileData } = data;
    
    console.log('Donn√©es re√ßues:', { fileName, codeUnique, companyName, logoType });
    
    // V√©rifier que companyName est pr√©sent
    if (!companyName || companyName.trim() === '') {
      console.error('Nom entreprise manquant');
      return createResponse(false, 'Nom entreprise manquant pour cr√©er le dossier');
    }
    
    // Obtenir ou cr√©er le dossier de l'entreprise
    const companyFolder = getOrCreateCompanyFolder(companyName.trim());
    
    if (!companyFolder) {
      console.error('Impossible de cr√©er le dossier pour:', companyName);
      return createResponse(false, 'Impossible de cr√©er le dossier entreprise');
    }
    
    console.log('Dossier entreprise trouv√©/cr√©√©:', companyFolder.getName(), 'ID:', companyFolder.getId());
    
    // D√©coder le fichier base64
    const blob = Utilities.newBlob(
      Utilities.base64Decode(fileData),
      contentType,
      fileName
    );
    
    // Cr√©er le fichier dans Drive
    const driveFile = companyFolder.createFile(blob);
    
    // Rendre le fichier accessible en lecture
    driveFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    const fileId = driveFile.getId();
    const fileUrl = driveFile.getUrl();
    
    console.log('Fichier cr√©√© dans Drive:', fileId, 'dans le dossier:', companyFolder.getName());
    
    // Mettre √† jour le Google Sheet avec le lien vers le DOSSIER
    const result = updateSheetWithFolderLink(codeUnique, logoType, companyFolder);
    
    if (!result.success) {
      // Si erreur Sheet, supprimer le fichier Drive
      console.log('Erreur Sheet, suppression du fichier Drive');
      driveFile.setTrashed(true);
      return result;
    }
    
    return createResponse(true, 'Fichier upload√© avec succ√®s', {
      fileId: fileId,
      fileName: fileName,
      fileSize: fileSize,
      fileUrl: fileUrl,
      logoType: logoType,
      uploadedAt: new Date().toISOString(),
      partnerCode: codeUnique,
      folderName: companyFolder.getName(),
      folderId: companyFolder.getId(),
      folderUrl: companyFolder.getUrl()
    });
    
  } catch (error) {
    console.error('Erreur upload fichier:', error);
    return createResponse(false, 'Erreur upload: ' + error.message);
  }
}

// Mettre √† jour le Sheet avec lien vers le dossier entreprise
function updateSheetWithFolderLink(codeUnique, logoType, companyFolder) {
  try {
    console.log('Mise √† jour Sheet avec lien dossier:', { codeUnique, logoType, folderName: companyFolder.getName() });
    
    const spreadsheet = SpreadsheetApp.openById(SHEET_ID);
    const sheet = spreadsheet.getSheetByName(DATA_SHEET_NAME);
    
    if (!sheet) {
      return createResponse(false, 'Onglet Data non trouv√©');
    }
    
    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    
    // D√©terminer la colonne selon le type de logo
    let columnName = '';
    if (logoType === 'CMJN') {
      columnName = 'Logo CMJN';
    } else if (logoType === 'N√©gatif') {
      columnName = 'Logo N√©gatif';
    } else {
      return createResponse(false, 'Type de logo non reconnu: ' + logoType);
    }
    
    const columnIndex = headers.indexOf(columnName);
    if (columnIndex === -1) {
      return createResponse(false, 'Colonne non trouv√©e: ' + columnName);
    }
    
    // Chercher le partenaire
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] && data[i][0].toString().trim() === codeUnique.toString().trim()) {
        
        // V√©rifier si le lien existe d√©j√†
        const currentValue = data[i][columnIndex];
        if (currentValue && currentValue.toString().trim() !== '') {
          console.log('Lien dossier d√©j√† pr√©sent pour', logoType);
          return createResponse(true, 'Lien dossier d√©j√† pr√©sent');
        }
        
        // Cr√©er la formule HYPERLINK vers le DOSSIER
        const folderUrl = companyFolder.getUrl();
        const hyperlinkFormula = `=HYPERLINK("${folderUrl}","üìÅ Dossier ${logoType}")`;
        
        // Mettre √† jour la cellule avec le lien hypertexte vers le dossier
        sheet.getRange(i + 1, columnIndex + 1).setFormula(hyperlinkFormula);
        
        // Mettre √† jour la date de modification
        const lastModColumnIndex = headers.indexOf('Derni√®re modification');
        if (lastModColumnIndex !== -1) {
          sheet.getRange(i + 1, lastModColumnIndex + 1).setValue(new Date());
        }
        
        // Mettre √† jour la progression
        updateProgression(sheet, headers, i + 1);
        
        // Invalider le cache
        invalidateCache();
        
        console.log('Lien hypertexte dossier ajout√© dans', columnName);
        return createResponse(true, 'Lien dossier ajout√© dans le Sheet');
      }
    }
    
    return createResponse(false, 'Partenaire non trouv√©');
    
  } catch (error) {
    console.error('Erreur mise √† jour Sheet:', error);
    return createResponse(false, 'Erreur mise √† jour Sheet: ' + error.message);
  }
}

// R√©cup√©rer les fichiers d'un partenaire
function getPartnerFiles(codeUnique) {
  try {
    console.log('R√©cup√©ration fichiers pour:', codeUnique);
    
    // Obtenir les donn√©es du partenaire
    const partnerResult = getPartnerData(codeUnique);
    if (!partnerResult.success) {
      return createResponse(false, 'Partenaire non trouv√©');
    }
    
    const partnerData = JSON.parse(partnerResult.getContent()).data;
    const companyName = partnerData['Nom Entreprise'];
    
    if (!companyName) {
      return createResponse(true, 'Aucun fichier', []);
    }
    
    // Chercher le dossier de l'entreprise
    const parentFolder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
    const cleanCompanyName = companyName.replace(/[<>:"/\\|?*]/g, '_').trim();
    const companyFolders = parentFolder.getFoldersByName(cleanCompanyName);
    
    if (!companyFolders.hasNext()) {
      return createResponse(true, 'Aucun fichier', []);
    }
    
    const companyFolder = companyFolders.next();
    const files = companyFolder.getFiles();
    
    const filesList = [];
    
    while (files.hasNext()) {
      const file = files.next();
      
      // D√©terminer le type de logo selon le nom
      let logoType = 'Document';
      const fileName = file.getName().toLowerCase();
      
      if (fileName.includes('cmjn') || fileName.includes('cmyk') || fileName.includes('couleur')) {
        logoType = 'CMJN';
      } else if (fileName.includes('negatif') || fileName.includes('n√©gatif') || fileName.includes('fond_sombre')) {
        logoType = 'N√©gatif';
      }
      
      filesList.push({
        fileId: file.getId(),
        fileName: file.getName(),
        fileSize: file.getSize(),
        logoType: logoType,
        uploadedAt: file.getDateCreated().toISOString(),
        fileUrl: file.getUrl()
      });
    }
    
    console.log('Fichiers trouv√©s:', filesList.length);
    return createResponse(true, 'Fichiers r√©cup√©r√©s', filesList);
    
  } catch (error) {
    console.error('Erreur r√©cup√©ration fichiers:', error);
    return createResponse(false, 'Erreur r√©cup√©ration fichiers: ' + error.message);
  }
}

// T√©l√©charger un fichier
function downloadFile(fileId) {
  try {
    console.log('T√©l√©chargement fichier:', fileId);
    
    const file = DriveApp.getFileById(fileId);
    const downloadUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
    
    return createResponse(true, 'URL de t√©l√©chargement g√©n√©r√©e', {
      downloadUrl: downloadUrl,
      fileName: file.getName(),
      fileSize: file.getSize()
    });
    
  } catch (error) {
    console.error('Erreur t√©l√©chargement fichier:', error);
    return createResponse(false, 'Fichier non trouv√© ou inaccessible');
  }
}

// Supprimer un fichier (le lien dossier reste)
function deleteFile(fileId, codeUnique, logoType) {
  try {
    console.log('Suppression fichier:', { fileId, codeUnique, logoType });
    
    // Supprimer le fichier de Drive
    const file = DriveApp.getFileById(fileId);
    file.setTrashed(true);
    
    console.log('Fichier supprim√© de Drive');
    
    // NOTE : On ne supprime PAS le lien du dossier dans le Sheet
    // car le dossier contient peut-√™tre d'autres fichiers
    
    return createResponse(true, 'Fichier supprim√© avec succ√®s');
    
  } catch (error) {
    console.error('Erreur suppression fichier:', error);
    return createResponse(false, 'Erreur suppression fichier: ' + error.message);
  }
}

function createResponse(success, message, data) {
  const response = {
    success: success,
    message: message,
    timestamp: new Date().toISOString()
  };
  
  if (data) {
    response.data = data;
  }
  
  console.log('R√©ponse envoy√©e:', response);
  
  return ContentService
    .createTextOutput(JSON.stringify(response))
    .setMimeType(ContentService.MimeType.JSON);
}

// Debug complet pour comprendre le probl√®me
function debugPartnerSync() {
  try {
    console.log('=== DEBUG SYNCHRONISATION PARTENAIRES ===');
    
    // Forcer le rechargement du cache
    invalidateCache();
    const { sheet, data, headers } = getSheetDataCached();
    
    console.log('DONN√âES ACTUELLES DANS LE SHEET:');
    console.log('Nombre total de lignes:', data.length);
    console.log('Nombre de partenaires:', data.length - 1);
    
    // Lister tous les codes partenaires
    console.log('CODES PARTENAIRES DANS LE SHEET:');
    for (let i = 1; i < data.length; i++) {
      const code = data[i][0];
      const company = data[i][headers.indexOf('Nom Entreprise')] || 'N/A';
      const contact = data[i][headers.indexOf('Nom Contact')] || 'N/A';
      console.log(i + '. Code: "' + code + '" | Entreprise: "' + company + '" | Contact: "' + contact + '"');
    }
    
    // V√©rifier les colonnes probl√©matiques
    console.log('V√âRIFICATION COLONNES PROBL√âMATIQUES:');
    const deadlineIndex = headers.indexOf('Deadline');
    const joursIndex = headers.indexOf('Jours restants');
    const prioriteIndex = headers.indexOf('Priorit√©');
    const atelierIndex = headers.indexOf('Atelier');
    const speedmeetingIndex = headers.indexOf('Speedmeeting');
    const regimesIndex = headers.indexOf('R√©gimes alimentaires et allergies');
    const tshirtsIndex = headers.indexOf('Tailles t-shirts');
    
    console.log('Deadline (colonne ' + (deadlineIndex + 1) + '):', deadlineIndex !== -1 ? 'Trouv√©e' : 'Non trouv√©e');
    console.log('Jours restants (colonne ' + (joursIndex + 1) + '):', joursIndex !== -1 ? 'Trouv√©e' : 'Non trouv√©e');
    console.log('Priorit√© (colonne ' + (prioriteIndex + 1) + '):', prioriteIndex !== -1 ? 'Trouv√©e' : 'Non trouv√©e');
    console.log('Atelier (colonne ' + (atelierIndex + 1) + '):', atelierIndex !== -1 ? 'Trouv√©e' : 'Non trouv√©e');
    console.log('Speedmeeting (colonne ' + (speedmeetingIndex + 1) + '):', speedmeetingIndex !== -1 ? 'Trouv√©e' : 'Non trouv√©e');
    console.log('R√©gimes alimentaires (colonne ' + (regimesIndex + 1) + '):', regimesIndex !== -1 ? 'Trouv√©e' : 'Non trouv√©e');
    console.log('Tailles t-shirts (colonne ' + (tshirtsIndex + 1) + '):', tshirtsIndex !== -1 ? 'Trouv√©e' : 'Non trouv√©e');
    
  } catch (error) {
    console.error('Erreur debug sync:', error);
  }
}

// Nettoyer les erreurs #REF!
function cleanRefErrors() {
  try {
    console.log('Nettoyage des erreurs #REF!...');
    
    const spreadsheet = SpreadsheetApp.openById(SHEET_ID);
    const sheet = spreadsheet.getSheetByName(DATA_SHEET_NAME);
    
    if (!sheet) {
      console.log('Onglet Data non trouv√©');
      return;
    }
    
    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    
    // Indices des colonnes probl√©matiques
    const deadlineIndex = headers.indexOf('Deadline');
    const joursIndex = headers.indexOf('Jours restants');
    const prioriteIndex = headers.indexOf('Priorit√©');
    
    let corrections = 0;
    
    // Parcourir toutes les lignes de donn√©es
    for (let i = 1; i < data.length; i++) {
      // Corriger Deadline
      if (deadlineIndex !== -1 && (data[i][deadlineIndex] === '#REF!' || !data[i][deadlineIndex])) {
        sheet.getRange(i + 1, deadlineIndex + 1).setValue('2025-09-01T22:00:00.000Z');
        corrections++;
      }
      
      // Corriger Jours restants
      if (joursIndex !== -1 && (data[i][joursIndex] === '#REF!' || !data[i][joursIndex])) {
        const joursRestants = calculateDaysRemaining('2025-09-01');
        sheet.getRange(i + 1, joursIndex + 1).setValue(joursRestants);
        corrections++;
      }
      
      // Corriger Priorit√©
      if (prioriteIndex !== -1 && (data[i][prioriteIndex] === '#REF!' || !data[i][prioriteIndex])) {
        sheet.getRange(i + 1, prioriteIndex + 1).setValue('üü¢ OK');
        corrections++;
      }
    }
    
    SpreadsheetApp.flush();
    invalidateCache(); // Invalider le cache apr√®s corrections
    
    console.log(corrections + ' corrections appliqu√©es');
    return createResponse(true, corrections + ' corrections appliqu√©es');
    
  } catch (error) {
    console.error('Erreur nettoyage:', error);
    return createResponse(false, 'Erreur: ' + error.message);
  }
}

// Fonctions de test
function testAuthentication() {
  console.log('Test authentification...');
  
  const result = authenticatePartner('C25TEST1234');
  console.log('R√©sultat:', result.getContent());
}

function testAdminFeatures() {
  console.log('Test des fonctionnalit√©s admin...');
  
  console.log('Test r√©cup√©ration tous partenaires...');
  const allPartnersResult = getAllPartners();
  console.log('R√©sultat tous partenaires:', allPartnersResult.getContent());
  
  console.log('Test ajout partenaire...');
  const addResult = addPartner('Test Company', 'John Doe', 'john@test.com', '0123456789');
  console.log('R√©sultat ajout:', addResult.getContent());
  
  console.log('Test export...');
  const exportResult = exportData();
  console.log('R√©sultat export:', exportResult.getContent());
}

function testSaveField() {
  console.log('Test sauvegarde champ sp√©cifique...');
  
  const result = saveField('C25TEST1234', 'Atelier', 'Test atelier sur la digitalisation');
  console.log('R√©sultat:', result.getContent());
  
  const result2 = saveField('C25TEST1234', 'Speedmeeting', 'Speed meeting innovation');
  console.log('R√©sultat 2:', result2.getContent());
  
  const result3 = saveField('C25TEST1234', 'Tailles t-shirts', '2x M, 1x L, 1x XL');
  console.log('R√©sultat 3:', result3.getContent());
}

function listAllCodesInData() {
  try {
    const { data, headers } = getSheetDataCached();
    
    console.log('Tous les codes dans onglet Data:');
    console.log('Headers:', headers);
    
    for (let i = 1; i < data.length; i++) {
      console.log('Ligne ' + (i + 1) + ': "' + data[i][0] + '"');
    }
    
  } catch (error) {
    console.error('Erreur:', error);
  }
}

function testGeneratePartnerCode() {
  console.log('Test g√©n√©ration codes partenaires...');
  
  for (let i = 0; i < 10; i++) {
    const code = generatePartnerCode();
    console.log('Code ' + (i + 1) + ': ' + code);
  }
}
